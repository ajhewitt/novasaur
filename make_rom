#!/bin/sh

# ATMEL OTP - AT27C020@DIP32
# SST NOR FLASH - SST39SF020A
# GLS NOR FLASH - SST27SF020@DIP32

# firmware
echo "Assemble Firmware"
echo ":020000040000FA" > build/output/rom.hex

for f in src/sys src/hal src/intel src/ext
do
  echo $f
  build/asm_hex.rb $f >> build/output/rom.hex
done

build/asm_hex.rb boot >> build/output/rom.hex

echo "Copy Cold Storage"
echo ":020000040001F9" >> build/output/rom.hex
build/repack_hex.rb lib/boot.hex 0 >> build/output/rom.hex
build/repack_hex.rb lib/disk.hex 1 >> build/output/rom.hex
build/repack_hex.rb lib/kernel.hex 2 >> build/output/rom.hex
build/repack_hex.rb lib/monitor.hex 10 >> build/output/rom.hex
build/pack_hex.rb lib/bdir.hex 16 >> build/output/rom.hex
build/bin2hex.rb lib/asm.com 20 >> build/output/rom.hex
build/repack_hex.rb lib/cpm22.hex 52 >> build/output/rom.hex
build/bin2hex.rb lib/ddt.com 76 >> build/output/rom.hex
build/bin2hex.rb lib/dump.com 96 >> build/output/rom.hex
build/bin2hex.rb lib/ed.com 100 >> build/output/rom.hex
build/bin2hex.rb lib/load.com 128 >> build/output/rom.hex
#build/bin2hex.rb lib/mbasic.com 136 >> build/output/rom.hex
build/bin2hex.rb lib/pip.com 168 >> build/output/rom.hex
build/bin2hex.rb lib/stat.com 200 >> build/output/rom.hex
build/bin2hex.rb lib/submit.com 224 >> build/output/rom.hex
#build/bin2hex.rb lib/xmodem.com 232 >> build/output/rom.hex
build/bin2hex.rb lib/xsub.com 252 >> build/output/rom.hex

echo "Building ALU"
build/alu_hex.rb >> build/output/rom.hex

echo "Building Fonts"
build/font_hex.rb >> build/output/rom.hex

echo ":00000001FF" >> build/output/rom.hex

echo "Burn ROM"
minipro -p "SST39SF020A" -w "build/output/rom.hex" -f ihex
